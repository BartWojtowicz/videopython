name: CI Pipeline
on:
  push:
  workflow_call:

jobs:
  base_tests:
    name: Base tests (no AI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install ffmpeg -y
      - name: Set up Python
        run: uv python install 312
      - name: Install dependencies
        run: uv sync --dev
      - name: Run base tests
        run: uv run pytest src/tests/base --cov=src/videopython/base --cov-report=term --cov-report=term-missing

  ai_tests:
    name: AI tests (lightweight)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install ffmpeg -y
      - name: Set up Python
        run: uv python install 312
      - name: Install all dependencies
        run: uv sync --all-extras --group ai
      - name: Run AI tests (skip heavy model downloads)
        run: uv run pytest src/tests/ai -m "not requires_model_download" -v

  static_checks:
    name: Linting and formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 312
      - name: Install dev dependencies
        run: uv sync --dev
      - name: Run Ruff lint checks
        run: uv run ruff check src
      - name: Run Ruff format checks
        run: uv run ruff format --check src

  mypy:
    name: Type tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 312
      - name: Install all dependencies
        run: uv sync --all-extras --group ai
      - name: Run type tests
        run: uv run mypy src

  docs:
    name: Documentation build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 312
      - name: Install dependencies
        run: uv sync --group dev
      - name: Build documentation
        run: uv run mkdocs build --strict

  version_check:
    name: Version consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check if version files changed
        id: changed
        run: |
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -qE '^(RELEASE_NOTES\.md|pyproject\.toml)$'; then
            echo "check=true" >> $GITHUB_OUTPUT
          else
            echo "check=false" >> $GITHUB_OUTPUT
          fi
      - name: Validate version consistency
        if: steps.changed.outputs.check == 'true'
        run: |
          PYPROJECT_VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          RELEASE_VERSION=$(grep -m1 '^## [0-9]' RELEASE_NOTES.md | sed 's/## //')

          if [ "$PYPROJECT_VERSION" != "$RELEASE_VERSION" ]; then
            echo "::error::Version mismatch! pyproject.toml has '$PYPROJECT_VERSION' but RELEASE_NOTES.md has '$RELEASE_VERSION'"
            exit 1
          fi
          echo "Versions match: $PYPROJECT_VERSION"
